<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  <header></header>
    
    <main class="container my-3">
      <h3>Mantenimiento de productos</h3>

      <form action="" method="post" id="form-producto">

      <div class="card">
        <div class="card-header">
          <strong>Complete los datos</strong>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-12 mb-2">
            <div class="form-floating">
              <input type="text" class="form-control rounded-0" id="descripcion" name="descripcion" minlength="3" required autofocus autocomplete="off">
              <label for="descripcion">Descripción</label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="form-floating">
              <select name="garantia" id="garantia" class="form-control rounded-0" required autofocus>
                <option value="">Seleccione</option>
                <option value="0">Sin Garantía</option>
                <option value="3">3 Meses</option>
                <option value="6">6 Meses</option>
                <option value="12">1 año</option>
                <option value="24">2 años</option>
                <option value="36">3 años</option>
              </select>
              <label for="garantia">Garantía</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-floating">
              <input type="text" name="precio" id="precio" pattern="[0-9]+" class="form-control rounded-0 text-end" title="Solo se permiten números" required autofocus>
              <label for="precio">Precio</label>
            </div>
          </div>
          <div class="card-footer text-end">
            <button type="reset" class="btn rounded-0 btn-outline-secondary">Cancelar</button>
            <button type="submit" class="btn rounded-0 btn-outline-secondary">Guardar</button>
          </div>
        </div>
      </div> 
      </form>

      <style>
        .table tbody tr td:nth-child(1){ text-align: center;}
        .table tbody tr td:nth-child(3){ text-align: center;}
        .table tbody tr td:nth-child(4){ text-align: center;}
        .table tbody tr td:nth-child(5){ text-align: center;}
      </style>

      <div class="table resposive mt-3">
        <table class="table table-bordered" name="tabla" id="tabla-productos">
          <colgroup>
            <col style="width: 8%;">
            <col style="width: 40%;">
            <col style="width: 13%;">
            <col style="width: 13%;">
            <col style="width: 26%;">
          </colgroup>
          <thead>
            <tr>
              <th class="text-center">ID</th>
              <th>Descripción</th>
              <th class="text-center">Garantía</th>
              <th class="text-center">Precio</th>
            </tr>
          </thead>
          <tbody>

          </tbody>
        </table>
      </div>

    </main>

  <footer></footer>

  <script>
    const API_URL = 'http://localhost:3000/api/productos'

    const formulario = document.getElementById('form-producto')
    const tabla = document.querySelector('#tabla-productos tbody')
    const descripcion = document.getElementById('descripcion')
    const garantia = document.getElementById('garantia')
    const precio = document.getElementById('precio')


    //Obetener los datos (backend) > renderizar en la tabl|a
    async function obtenerProductos(){

     const response = await fetch(API_URL, { method: 'get' })  
     const productos = await response.json()
     //console.log(productos)

     //Reiniciamos el contenido de la tabla
     tabla.innerHTML='';
     
     productos.forEach(producto => {
     //Crear una nueva fila y celdas con los datos contenidos en JSON
      const row = tabla.insertRow()

      row.insertCell().textContent = producto.id
      row.insertCell().textContent = producto.descripcion
      row.insertCell().textContent = producto.garantia
      row.insertCell().textContent = producto.precio 

      //La última cewlda contendrá 2 botones (funcionalidad)
      const actionCell = row.insertCell()

      //Botón 1: Editar
      const editButton = document.createElement('button')
      editButton.textContent = 'Editar'
      editButton.classList.add('btn')
      editButton.classList.add('btn-info')
      editButton.classList.add('btn-sm')
      editButton.onclick = () => cargarParaEdicion(producto)

      //Botón 2: Eliminar
      const deleteButton = document.createElement('button')
      deleteButton.textContent = 'Eliminar'
      deleteButton.classList.add('btn')
      deleteButton.classList.add('btn-danger')
      deleteButton.classList.add('btn-sm')
      deleteButton.onclick = () => eliminarProducto(producto.id, producto.descripcion)


      //Agregando ambos botones a la ultima celda
      actionCell.appendChild(editButton)
      actionCell.appendChild(deleteButton)

     });

    }

    async function eliminarProducto(id, descripcion){
      if(confirm(`¿Esta seguro de eliminar el producto: ${descripcion}?`)){
        try{
          const response = await fetch(API_URL + `/${id}`, { method: 'delete' })
          

          if(!response.ok){
            throw new Error(`Error al eliminar: ${descripcion}`)
          }

          //Eliminado correctamente...
          const result = await response.json()
          console.log(result)
          obtenerProductos()

        }catch(e){
          console.error(e)
        }
      }
    }

    formulario.addEventListener("submit", async (event) => {
      event.preventDefault()
      
      //Para guardar, necesitamos alamacenar datos en formato json
      //preparamos un objeto de JS con la misma estructura
      const data = {
        descripcion: descripcion.value,
        garantia: parseInt(garantia.value),
        precio: parseFloat(precio.value) 
      }  
      
      //Enviar los datos (1. URL, 2. Verbo, 3. Tipo dato, 4. JSON)
      try{
        const response = await fetch(API_URL, { 
          method: 'post',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
         })
         const result = await response.json()
         console.log(result)
      }catch(e){
        console.error(e)
      }
    })
    //Cuando la pagina este lista, se ejecutará obtenerProductos
    document.addEventListener('DOMContentLoaded', obtenerProductos)




  </script>
</body>
</html>