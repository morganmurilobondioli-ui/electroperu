<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mantenimiento de Clientes</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <main class="container my-3">
    <h3>Mantenimiento de Clientes</h3>

    <form id="form-cliente">
      <input type="hidden" id="idcliente" />

      <div class="card">
        <div class="card-header">
          <strong>Complete los datos del cliente</strong>
        </div>

        <div class="card-body">
          <div class="row mb-2">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="apellidos" class="form-control rounded-0" placeholder="Apellidos" required />
                <label for="apellidos">Apellidos</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="nombres" class="form-control rounded-0" placeholder="Nombres" required />
                <label for="nombres">Nombres</label>
              </div>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-3">
              <div class="form-floating">
                <input type="text" id="dni" maxlength="8" class="form-control rounded-0" placeholder="DNI" required />
                <label for="dni">DNI</label>
              </div>
            </div>

            <div class="col-md-3">
              <div class="form-floating">
                <input type="text" id="telefono" class="form-control rounded-0" placeholder="Teléfono" />
                <label for="telefono">Teléfono</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" id="direccion" class="form-control rounded-0" placeholder="Dirección" />
                <label for="direccion">Dirección</label>
              </div>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-6">
              <div class="form-floating">
                <select id="tienda_id" class="form-select rounded-0" required>
                  <option value="">Seleccione tienda</option>
                </select>
                <label for="tienda_id">Tienda</label>
              </div>
            </div>
          </div>

          <div class="card-footer text-end">
            <button type="reset" id="btnCancelar" class="btn btn-outline-secondary rounded-0">Cancelar</button>
            <button type="submit" id="btnGuardar" class="btn btn-outline-primary rounded-0">Guardar</button>
          </div>
        </div>
      </div>
    </form>

    <div class="table-responsive mt-4">
      <table class="table table-bordered" id="tabla-clientes">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Apellidos</th>
            <th>Nombres</th>
            <th>DNI</th>
            <th>Teléfono</th>
            <th>Dirección</th>
            <th>Tienda</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    const API_URL = 'http://localhost:3000/api/clientes';
    const API_TIENDAS = 'http://localhost:3000/api/tiendas'; // si luego haces CRUD de tiendas

    const form = document.getElementById('form-cliente');
    const tabla = document.querySelector('#tabla-clientes tbody');

    const idcliente = document.getElementById('idcliente');
    const apellidos = document.getElementById('apellidos');
    const nombres = document.getElementById('nombres');
    const dni = document.getElementById('dni');
    const telefono = document.getElementById('telefono');
    const direccion = document.getElementById('direccion');
    const tiendaSelect = document.getElementById('tienda_id');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnCancelar = document.getElementById('btnCancelar');

    btnCancelar.addEventListener('click', () => {
      btnGuardar.innerText = 'Guardar';
      form.reset();
    });

    // Cargar tiendas para el select
    async function cargarTiendas() {
      try {
        const res = await fetch(API_TIENDAS);
        if (!res.ok) throw new Error('Error al obtener tiendas');
        const tiendas = await res.json();

        tiendaSelect.innerHTML = '<option value="">Seleccione tienda</option>';
        tiendas.forEach((t) => {
          const option = document.createElement('option');
          option.value = t.id;
          option.textContent = t.tienda;
          tiendaSelect.appendChild(option);
        });
      } catch (e) {
        console.error(e);
      }
    }

    // Obtener clientes
    async function obtenerClientes() {
      const res = await fetch(API_URL);
      const clientes = await res.json();

      tabla.innerHTML = '';

      clientes.forEach((cliente) => {
        const row = tabla.insertRow();

        row.insertCell().textContent = cliente.id;
        row.insertCell().textContent = cliente.apellidos;
        row.insertCell().textContent = cliente.nombres;
        row.insertCell().textContent = cliente.dni;
        row.insertCell().textContent = cliente.telefono || '';
        row.insertCell().textContent = cliente.direccion || '';
        row.insertCell().textContent = cliente.nombre_tienda || '';

        const actionCell = row.insertCell();

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Editar';
        editBtn.classList.add('btn', 'btn-sm', 'btn-info', 'me-1');
        editBtn.onclick = () => cargarParaEdicion(cliente);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Eliminar';
        deleteBtn.classList.add('btn', 'btn-sm', 'btn-danger');
        deleteBtn.onclick = () => eliminarCliente(cliente.id, cliente.apellidos);

        actionCell.append(editBtn, deleteBtn);
      });
    }

    // Cargar cliente en formulario
    function cargarParaEdicion(cliente) {
      idcliente.value = cliente.id;
      apellidos.value = cliente.apellidos;
      nombres.value = cliente.nombres;
      dni.value = cliente.dni;
      telefono.value = cliente.telefono;
      direccion.value = cliente.direccion;
      tiendaSelect.value = cliente.tienda_id;

      btnGuardar.innerText = 'Actualizar';
    }

    // Eliminar cliente
    async function eliminarCliente(id, nombre) {
      if (confirm(`¿Desea eliminar al cliente ${nombre}?`)) {
        const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        if (res.ok) {
          obtenerClientes();
        }
      }
    }

    // Guardar / actualizar cliente
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        apellidos: apellidos.value,
        nombres: nombres.value,
        dni: dni.value,
        telefono: telefono.value,
        direccion: direccion.value,
        tienda_id: parseInt(tiendaSelect.value),
      };

      let res;
      if (idcliente.value === '') {
        res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
      } else {
        res = await fetch(`${API_URL}/${idcliente.value}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
      }

      if (res.ok) {
        form.reset();
        btnGuardar.innerText = 'Guardar';
        obtenerClientes();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      cargarTiendas();
      obtenerClientes();
    });
  </script>
</body>
</html>